@page
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf

@model contextual_notes.Pages.IndexModel
@{
    ViewData["Title"] = "Home page";
}


<form asp-page-handler="Create" method="post">
    @Html.DropDownListFor(x => x.CollectionName, new SelectList(@Model.Collections, "", ""), "Select Collection", new { onchange = "loadTable()", id = "ddlCollection" })

    <div id="createForm" style="display:none">

        <label> Url:</label>
        <input asp-for="NoteItem.Url" />
        <label> Notes:</label>

        <input asp-for="NoteItem.Comments" />
        <label>Is this a tutorial? </label>

        <input asp-for="NoteItem.Tutorial" type="checkbox" />
        <input type="submit" value="Save" class="btn btn-default" />
    </div>

</form>

<input type="button" value="Add New" onclick="$('#createForm').toggle()" id="AddBtn" style="display:none" /> <br />


 Searching by (Select up to 2): <div id="searchBy" name="searchTerms"></div><br />
<input type="text" value="Search" id="queryText" />

<input type="button" value="Search" id="searchBtn" onclick="search()" style="display:none" /><br />


<div id="searchItems">

</div>

<table id="noteTable" class="table table-striped">
    <thead>

    </thead>
</table>

<form>
    <input name="__RequestVerificationToken" type="hidden" value="CfDJ8KW5cuB058RCnNyZSLI7AUjUAtTwe54jQ4Z9Goyn3WKPcpVFYSFUM5J-JDFC3E-MZIUcyR0UnbrvrC_sHv6MbUONStuIMhqDc7i00pQiGkrzf3hK6t5gZFVrjUpyAcargow4zvKU_ISjdPfoLTNF588" />
</form>


<script type="text/javascript">

    function loadTable() {
        var select = $("#ddlCollection option:selected").text();
        $("#AddBtn").show();
        $("#searchBtn").show();

        $.ajax({
            type: "GET",
            url: "/Index/?handler=List&selectedCollection=" + select,
            contentType: "application/json",
            dataType: "json",
            success: function (response) {

                var jsonTable = new JSONTable($("#noteTable"))
                var headerData = jsonTable.fromJSON(JSON.parse(response), select)

                for (x in headerData) {

                    $("#searchItems").append("<span class='badge' onclick='addToQuery(this)'>" + headerData[x] + "</span>")
                }

            },
            failure: function (response) {
                alert(response);
            }
        });
    }

    function search() {
        var select = $("#ddlCollection option:selected").text();


        $.ajax({
            type: "POST",
            url: "/Index/?handler=Search&selectedCollection=" + select + "&searchTerms=" + $("#searchBy").text() + "&searchText=" + $("#queryText").val(),
            contentType: 'application/json',
            dataType: "json",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("RequestVerificationToken",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },
            success: function (response) {

                var jsonTable = new JSONTable($("#noteTable"))
                var headerData = jsonTable.fromJSON(JSON.parse(response), select)

                for (x in headerData) {

                    $("#searchItems").append("<span class='badge' onclick='addToQuery(this)'>" + headerData[x] + "</span>")
                }

            },
            failure: function (response) {
                alert(response);
            }
        });
    }

    function addToQuery(item) {

        if ($("span.badge-success").length < 2 && !$(item).hasClass("badge-success"))
        {
            $(item).toggleClass("badge-success")
            $("#searchBy").append($(item).text() + " ")
        }
        else
        {
            $(item).hasClass("badge-success").toggleClass("badge-success")
            $("#searchBy").text($(this).text().replace($(item).text() + " ", ""))
        }

    }


</script>  